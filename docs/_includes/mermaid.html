<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
    (function () {
        function upgradeMermaidCodeBlocks() {
            const codes = new Set();
            
            // 1) 標準：<pre><code class="language-mermaid">...</code></pre>
            document.querySelectorAll('pre code.language-mermaid').forEach(c => codes.add(c));
            
            // 2) Jekyll/Rouge：<div class="language-mermaid ..."><div class="highlight"><pre><code>...</code></pre></div></div>
            document.querySelectorAll('div.language-mermaid pre code').forEach(c => codes.add(c));
            
            // 3) 其他備援：<code data-lang="mermaid">...</code>
            document.querySelectorAll('code[data-lang="mermaid"]').forEach(c => codes.add(c));
            
            codes.forEach(code => {
                const wrapper = code.closest('.language-mermaid') || code.closest('pre') || code.parentElement;
                const div = document.createElement('div');
                div.className = 'mermaid';
                div.textContent = code.textContent; // 保留純文字（避免 <<...>> 被吃掉）
                wrapper.replaceWith(div);
            });
        }
        
        document.addEventListener('DOMContentLoaded', function () {
            upgradeMermaidCodeBlocks();
            mermaid.initialize({ startOnLoad: true, securityLevel: 'loose' });
        });
    })();
</script>
