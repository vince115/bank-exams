<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
    (function () {
        function toMermaidDivs(root = document) {
            const codes = new Set();
            // 標準：```mermaid → <pre><code class="language-mermaid">
            root.querySelectorAll('pre code.language-mermaid').forEach(c => codes.add(c));
            // Jekyll/Rouge 包裝：<div class="language-mermaid"><div class="highlight"><pre><code>…</code></pre></div></div>
            root.querySelectorAll('div.language-mermaid pre code').forEach(c => codes.add(c));

            codes.forEach(code => {
                const wrapper = code.closest('.language-mermaid') || code.closest('pre');
                if (!wrapper || wrapper.dataset.mermaidUpgraded) return;
                const div = document.createElement('div');
                div.className = 'mermaid';
                div.textContent = code.textContent;   // 用純文字避免被轉義
                wrapper.dataset.mermaidUpgraded = '1';
                wrapper.replaceWith(div);
            });
        }

        function render(root = document) {
            if (!window.mermaid) { setTimeout(() => render(root), 50); return; }
            mermaid.initialize({ startOnLoad: false, securityLevel: 'loose' });
            const sel = root === document ? '.mermaid' : ':scope .mermaid';
            mermaid.run({ querySelector: sel });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // 先渲染可見區塊
            toMermaidDivs(document);
            render(document);
            // <details> 展開時再渲染其內的圖
            document.querySelectorAll('details').forEach(d => {
                d.addEventListener('toggle', e => {
                    if (!e.target.open) return;
                    toMermaidDivs(e.target);
                    render(e.target);
                });
            });
        });
    })();
</script>