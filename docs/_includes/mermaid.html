<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
    (function () {
        function toMermaidDivs(root = document) {
            const codes = new Set();
            // 標準：```mermaid → <pre><code class="language-mermaid">
            root.querySelectorAll('pre code.language-mermaid').forEach(c => codes.add(c));
            // GitHub Pages / Jekyll / Rouge 包裝
            root.querySelectorAll('div.language-mermaid pre code').forEach(c => codes.add(c));

            codes.forEach(code => {
                const wrapper = code.closest('.language-mermaid') || code.closest('pre');
                if (wrapper && !wrapper.dataset.mermaidUpgraded) {
                    const div = document.createElement('div');
                    div.className = 'mermaid';
                    div.textContent = code.textContent; // 保留純文字，避免被轉義
                    wrapper.dataset.mermaidUpgraded = '1';
                    wrapper.replaceWith(div);
                }
            });
        }

        function render(root = document) {
            if (!window.mermaid) { setTimeout(() => render(root), 50); return; }
            mermaid.initialize({ startOnLoad: false, securityLevel: 'loose' });
            const sel = root === document ? '.mermaid' : ':scope .mermaid';
            mermaid.run({ querySelector: sel });
        }

        // 首次渲染（<details> 外的圖）
        document.addEventListener('DOMContentLoaded', () => {
            toMermaidDivs(document);
            render(document);

            // 在 <details> 展開時，再轉換+渲染裡面的圖
            document.querySelectorAll('details').forEach(d => {
                d.addEventListener('toggle', e => {
                    if (!e.target.open) return;
                    toMermaidDivs(e.target);
                    render(e.target);
                });
            });
        });
    })();
</script>